<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.collaboportal.shoho.repository.PrescriptionDispMapper">

    <!-- 処方元情報の詳細画面初期表示データを取得するSQL -->
    <select 
        id="refer"
        resultType="com.collaboportal.shoho.entity.PrescriptionDispResult">
        SELECT
            kkk.I_KIKAKU_MEI AS pre_kkk_nm,
            shm.I_TOK_RYK_MEI_KJ AS pre_nhn_nm,
            shm.I_TOK_COD AS pre_tok_cod,
            FORMAT(CONVERT(DATE, shm.I_URIAGE_YMD, 112), 'yyyy/MM/dd') AS pre_dnp_ymd,
            CONCAT(RTRIM(LTRIM(shm.I_DPY_NO)), '-', RTRIM(LTRIM(shm.I_DPY_BNO)), '-', RTRIM(LTRIM(shm.I_DPY_KNO_GB))) AS pre_dnp_no,
            CONCAT(RTRIM(LTRIM(shm.I_SYH_MEI_KNKJ)), ' ', RTRIM(LTRIM(shm.I_SYH_KKK_YRY_MEI_KNKJ))) AS pre_syh_kkk_yry,
            shm.I_JAN_COD AS pre_syh_cod,
            shm.I_HNB_NUM AS pre_hnb_num,
            shm.I_DCF_COD AS pre_dcf_cod,
            shm.I_SST_RYAKU_NAME AS pre_nm,
            shm.I_SSZ_NAME AS pre_ful_nm,
            CASE
                WHEN shm.I_FUMEI_KBN &amp; 1 != 0 THEN 1
                ELSE 0
            END AS pre_cod,
            shm.I_FUMEI_RYU AS pre_ryu,
            shm.I_DR AS pre_dr,
            CASE
                WHEN shm.I_FUMEI_KBN &amp; 4 != 0 THEN 1
                ELSE 0
            END AS pre_dr_cod,
            CASE
                WHEN kkk.I_DRINPUT_FG = 1 THEN 1
                ELSE 0
            END AS pre_dr_input_flg,
            shm.I_SYRK AS pre_dp,
            CASE
                WHEN shm.I_FUMEI_KBN &amp; 2 != 0 THEN 1
                ELSE 0
            END AS pre_dp_cod,
            shm.I_MR_RNRK_ZKU AS pre_mr_ren,
            CASE 
                WHEN shm.I_NRK_YMD IS NULL THEN 0 
                ELSE 1 
            END AS pre_stat_flg
        FROM
            shohomoto_info.TR_SHOHOMOTO_INF AS shm
        INNER JOIN 
            shohomoto_info.MS_KIKAKU AS kkk
        ON 
            shm.I_KIKAKU_ID = kkk.I_KIKAKU_ID
        WHERE
            shm.I_DPY_BNO = #{dpy_bno}
            AND shm.I_DPY_KNO_GB = #{dpy_kno}
            AND shm.I_DPY_NO = #{dpy_no}
            AND shm.I_DPY_LNO = #{dpy_lno}
            AND shm.I_URIAGE_YMD = #{uriage_ymd}
    </select>
</mapper>