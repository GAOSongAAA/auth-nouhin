<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="logLevel" value="${util.log.level}"/>
    
    <!-- 標準控制台輸出（不含掩碼） -->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <!-- この指定をしないと文字化けする → おそらくDBから返却されているエラーメッセージが日本語のため -->
            <charset>UTF-8</charset>
            <pattern><![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tthread:%thread\tX-Track:%X{X-Track}\tlevel:%-5level\tlogger:%-48logger{48}\tmessage:%replace(%msg){'(\r\n|\r|\n)','$1  '}%n%replace(%replace(%xEx){'(\r\n|\r|\n)','$1  '}){'  $',''}%nopex]]></pattern>
        </encoder>
    </appender>
    
    <!-- 敏感信息掩碼控制台輸出 -->
    <appender name="STDOUT_MASKED" class="ch.qos.logback.core.ConsoleAppender">
        <!-- 敏感信息掩碼過濾器 -->
        <filter class="com.collaboportal.common.filter.SensitiveDataMaskingFilter"/>
        
        <!-- 敏感信息掩碼編碼器 -->
        <encoder class="com.collaboportal.common.encoder.SensitiveDataMaskingEncoder">
            <charset>UTF-8</charset>
            <pattern><![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tthread:%thread\tX-Track:%X{X-Track}\tlevel:%-5level\tlogger:%-48logger{48}\tmessage:%replace(%msg){'(\r\n|\r|\n)','$1  '}%n%replace(%replace(%xEx){'(\r\n|\r|\n)','$1  '}){'  $',''}%nopex]]></pattern>
            <enableMasking>true</enableMasking>
            <preserveOriginalMessage>false</preserveOriginalMessage>
        </encoder>
    </appender>
    
    <!-- 文件輸出（含掩碼） -->
    <appender name="FILE_MASKED" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/application-masked.log</file>
        
        <!-- 敏感信息掩碼過濾器 -->
        <filter class="com.collaboportal.common.filter.SensitiveDataMaskingFilter"/>
        
        <!-- 滾動策略：修復 %i 令牌問題 -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>logs/application-masked.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>1GB</totalSizeCap>
        </rollingPolicy>
        
        <!-- 敏感信息掩碼編碼器 -->
        <encoder class="com.collaboportal.common.encoder.SensitiveDataMaskingEncoder">
            <charset>UTF-8</charset>
            <pattern><![CDATA[date:%d{yyyy-MM-dd HH:mm:ss}\tthread:%thread\tX-Track:%X{X-Track}\tlevel:%-5level\tlogger:%-48logger{48}\tmessage:%replace(%msg){'(\r\n|\r|\n)','$1  '}%n%replace(%replace(%xEx){'(\r\n|\r|\n)','$1  '}){'  $',''}%nopex]]></pattern>
            <enableMasking>true</enableMasking>
        </encoder>
    </appender>
    <!-- アプリのログ出力レベル -->
    <!-- クエリの実行ログもこの設定に含まれる -->
    <logger name="com.collaboportal.shoho">
        <!-- <level value="trace" /> -->
    </logger>

    <!-- フレームワークのログ出力レベル -->
    <!-- <logger name="org.springframework">
        <level value="warn" />
    </logger> -->

    <!-- <logger name="org.springframework.web.servlet">
        <level value="info" />
    </logger> -->

    <!-- <logger name="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping">
        <level value="trace" />
    </logger> -->

    <!-- <logger name="org.springframework.jdbc.core.JdbcTemplate">
        <level value="debug" />
    </logger> -->

    <!-- 根日誌配置 -->
    <root level="info">
        <!-- 使用掩碼控制台輸出 -->
        <appender-ref ref="STDOUT_MASKED" />
        <!-- 使用掩碼文件輸出 -->
        <appender-ref ref="FILE_MASKED" />
        
        <!-- 可選：同時輸出到標準控制台（用於對比） -->
        <!-- <appender-ref ref="STDOUT" /> -->
    </root>
    
    <!-- 開發環境配置 -->
    <springProfile name="dev">
        <root level="debug">
            <appender-ref ref="STDOUT" />
            <!-- 開發環境可以選擇不使用掩碼 -->
        </root>
    </springProfile>
    
    <!-- 測試環境配置 -->
    <springProfile name="test">
        <root level="info">
            <appender-ref ref="STDOUT_MASKED" />
            <appender-ref ref="FILE_MASKED" />
        </root>
    </springProfile>
    
    <!-- 生產環境配置 -->
    <springProfile name="prod,production">
        <root level="warn">
            <appender-ref ref="FILE_MASKED" />
            <!-- 生產環境強制使用掩碼並且只輸出到文件 -->
        </root>
    </springProfile>

</configuration>